import{s as c}from"./main-CXmArxYQ.js";import{DeviceService as u}from"./deviceService-qYVlun15.js";const p="BIfw94xz-PKU3-nm_zQDLPdva9nbrEn3ae0mNBGQ5Y4ec7D3cRaZ-1jSosMx0TBNrvskvNf9-9C8iY5EZHGY9N8";function d(r){const e="=".repeat((4-r.length%4)%4),t=(r+e).replace(/\-/g,"+").replace(/_/g,"/"),s=window.atob(t),n=new Uint8Array(s.length);for(let i=0;i<s.length;++i)n[i]=s.charCodeAt(i);return n}const o={isSupported:()=>"serviceWorker"in navigator&&"PushManager"in window,subscribe:async r=>{if(!o.isSupported())return console.warn("Push notifications are not supported in this browser"),null;try{const e=await navigator.serviceWorker.ready;let t=await e.pushManager.getSubscription();if(!t){const s=d(p);t=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:s})}return await o.saveSubscription(t,r),console.log("✅ Push subscription successful"),t}catch(e){return console.error("❌ Push subscription failed:",e),null}},unsubscribe:async()=>{if(!o.isSupported())return!1;try{const e=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return e?(await e.unsubscribe(),await o.deleteSubscription(e),console.log("✅ Push unsubscribed"),!0):!1}catch(r){return console.error("❌ Push unsubscribe failed:",r),!1}},getSubscription:async()=>{if(!o.isSupported())return null;try{return await(await navigator.serviceWorker.ready).pushManager.getSubscription()}catch(r){return console.error("Failed to get subscription:",r),null}},saveSubscription:async(r,e)=>{var n,i;const t=u.getDeviceId(),s=r.toJSON();try{const{error:a}=await c.from("push_subscriptions").upsert({device_id:t,user_id:e,endpoint:s.endpoint,p256dh:(n=s.keys)==null?void 0:n.p256dh,auth:(i=s.keys)==null?void 0:i.auth,updated_at:new Date().toISOString()},{onConflict:"device_id"});a?console.error("Error saving push subscription:",a):console.log("✅ Push subscription saved to database")}catch(a){console.error("Failed to save push subscription:",a)}},deleteSubscription:async r=>{const e=u.getDeviceId();try{const{error:t}=await c.from("push_subscriptions").delete().eq("device_id",e);t&&console.error("Error deleting push subscription:",t)}catch(t){console.error("Failed to delete push subscription:",t)}},getSubscriptionStatus:async()=>o.isSupported()?await o.getSubscription()?"subscribed":"not-subscribed":"unsupported"};export{o as PushService};
